<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="addBilling.css">
<script type="text/javascript" src="jquery-1.8.2.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cc.hostedpci.com/WBSStatic/site60/proxy/js/hpci-cciframe-1.0.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cc.hostedpci.com/WBSStatic/site60/proxy/js/jquery.ba-postmessage.min.js" charset="utf-8"></script>
</head>

<body>

	<script type="text/javascript">
		var parent_host_url = encodeURIComponent("file:///android_asset/htdocs");
		var hpciCCFrameHost = "https://cc.hostedpci.com";
		var parent_host_query_string = encodeURIComponent("/hpci/index_prod.html");
		var hpciCCFrameFullUrl = null;
		var hpciCCFrameName = "mdliveframe";
		var billingData = null;
        //Trigger saving dialog to let the user now we have a procces going
		var triggerSavingDialog = null;
		var sendMessage = null;
        var bindMonthPicker = null;
        var errorHandlerRegexValidation = null;

		var hpciSiteErrorHandler = function(errorCode, errorMsg) {
			console.log("Failure : " + JSON.stringify(errorMsg));
			//Error result will be handled by main UI page, we just need to pass 0 here
			self.sendMessage(this.billingData);
		};

		var hpciSiteSuccessHandlerV2 = function(mappedCCValue, mappedCVVValue,
				ccBINValue) {
			console.log("Tokenizing success!");
			this.mergeDataBillingWithToken(mappedCCValue, mappedCVVValue,
					ccBINValue);
			self.sendMessage(this.billingData);
		};

		var hpci3DSitePINSuccessHandler = function() {
		};

		var hpci3DSitePINErrorHandler = function() {
			alert("Could not verify PIN for the credit card");
		};

		var collectBillingInfo = function() {
			var name = jQuery('.billing-name').val();
			var city = jQuery('.billing-city').val();
			var state = jQuery('.billing-state').val();
			var zip = jQuery('.billing-zip').val();
			var expDate = jQuery('.add-billing-expDate').val();
			var year = expDate.substring(3);
			var month = expDate.substring(0, 2);
			var address1 = jQuery('.billing-address-one').val();
			var address2 = jQuery('.billing-address-two').val();

			if (isValidateAt('.add-billing-required-fields')) {
				this.billingData = {
					"billing_information" : {
						"billing_name" : name,
						"cc_expyear" : year,
						"cc_expmonth" : month,
						"billing_city" : city,
						"billing_state_id" : state,
						"billing_zip5" : zip,
						"billing_country_id" : "1", //US exclusive
						"billing_address1" : address1,
						"billing_address2" : address2,
						"cc_num" : 0,
						"cc_cvv2" : 0,
						"cc_hsa" : true,
						"cc_type_id" : 0
					}
				};

			} else {
				this.billingData = {
					"status" : "not complete"
				};
			}
		};

		var getCCTypeId = function(mappedCCValue) {
			// 1    Visa
			// 2    MasterCard
			// 3    Discover
			// 5    AMEX
			// Using basic regex validation
			var re = new RegExp("^4");
			if (mappedCCValue.match(re) != null)
				return 1; //VISA

			re = new RegExp("^5[1-5]");
			if (mappedCCValue.match(re) != null)
				return 2; //MasterCard

			re = new RegExp("^6011");
			if (mappedCCValue.match(re) != null)
				return 3; //Discover

			re = new RegExp("^(34|37)");
			if (mappedCCValue.match(re) != null)
				return 5; //Amex
			return 0;
		};

		var mergeDataBillingWithToken = function(mappedCCValue, mappedCVVValue,
				ccBINValue) {
			this.billingData.billing_information.cc_num = mappedCCValue;
			this.billingData.billing_information.cc_cvv2 = mappedCVVValue;
			this.billingData.billing_information.cc_type_id = this
					.getCCTypeId(mappedCCValue);
		};

		var tokenizeForm = function() {

		var iframe = document.getElementById('mdliveframe');
        var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
        var cccvvValue = innerDoc.getElementById('ccCVV').value;
        var ccNumValue = innerDoc.getElementById('ccNum').value;
        var cccvvValueCheck = cccvvValue.toString();

        if (!isValidateAt('.add-billing-required-fields') || cccvvValue.trim().length==0 || ccNumValue.trim().length==0 ) {
            this.billingData = {
					"status" : "not complete"
				};
            this.sendMessage(this.billingData);
            return false;
        }else if(!/^[0-9]+$/.test(cccvvValueCheck) || cccvvValueCheck.length>4 || cccvvValueCheck.length<3){
            this.errorHandlerRegexValidation('securitycode');
            return false;
        }

			setTimeout(
					function() {
						jQuery('input').blur();
						var oError = new Error();
						this.billingData = null;
						//Set hostedPCI URL. This will be use to refresh the HPCI iframe when user failed to input correct cc number or cvv
						this.hpciCCFrameFullUrl = "https://cc.hostedpci.com/iSynSApp/showPxyPage!ccFrame.action?pgmode1=prod&locationName=mobile&sid=527123&fullParentHost="
								+ this.parent_host_url
								+ "&fullParentQStr="
								+ this.parent_host_query_string;

						this.collectBillingInfo();
						this.triggerSavingDialog();

						// 1. Tokenize the cc number after all required fields are fulfilled
						if (!this.billingData.billing_information) {
							//1a. If a user did not complete their billing info, we will inform him with pop up
							console.log("Required fields are not complete");
							return this.sendMessage(this.billingData);
						} else {
							//1b. When billing info is complete, we will try to tokenize the credit card number and cvv
							console.log("Tokenizing...");
							return sendHPCIMsg();
						}
					}, 50);
		};

		/**
		 * match a string with spesific regex
		 */
		var matchStringWithRegex = function(comparationString, regex) {
			if (regex == undefined || regex == null) {
				regex = /[^a-z0-9 ]/gi;
			}
			return regex.test(comparationString);
		};

		/**
		 * Validate value from its class according to given regex.
		 * @validateClass : Class which its value will be validated. It can contain an array of string or just a string.
		 * @regex : Regex which will validate to value it can contain an array of string or just a string.
		 */
		var validateValueClassAt = function(validateClass, regex) {
			var isValidate = true;

			jQuery(validateClass)
					.each(
							function() {
								var value = jQuery(this).val();
								if (value == '' || value == null || value == 0) {
									isValidate = false;
									return false;
								}
								if (isValidate && regex != null) {
									var isValidateWithRegex = true;
									if (jQuery.isArray(regex)) {
										for ( var regexIndex in regex) {
											isValidateWithRegex = (matchStringWithRegex(
													value, regex[regexIndex]) && isValidateWithRegex);
										}
									} else {
										isValidateWithRegex = matchStringWithRegex(
												value, regex);
									}

									if (!isValidateWithRegex) {
										isValidate = false;
										return false;
									}
								}
							});

			return isValidate;
		};

		/**
		 * Parse validateClass if it an array or not and call validateValueClassAt method to validate its value.
		 * @validateClass : Class which its value will be validated. It can contain an array of string or just a string.
		 * @regex : Regex which will validate to value it can contain an array of string or just a string.
		 */
		var isValidateAt = function(validateClass, regex) {
			var isValidate = true;

			if (jQuery.isArray(validateClass)) {
				for ( var validateClassIndex in validateClass) {
					if (!validateValueClassAt(
							validateClass[validateClassIndex], regex)) {
						isValidate = false;
					}
				}
			} else {
				if (!validateValueClassAt(validateClass, regex)) {
					isValidate = false;
				}
			}

			return isValidate;
		};

		var setExpiredDate = function(month, year) {
			if (month != 0) {
				if (month < 10) {
					jQuery(".add-billing-expDate")
							.val("0" + month + "/" + year);
				} else {
					jQuery(".add-billing-expDate").val(month + "/" + year);
				}
			}

		};

		var setSavedBillingInfo = function(billingInfoData) {
			if (billingInfoData && billingInfoData.billing_information) {
				jQuery(".add-billing-expDate")
						.val(
								billingInfoData.billing_information.cc_expmonth
										+ "/"
										+ billingInfoData.billing_information.cc_expyear);
				jQuery(".billing-name").val(
						billingInfoData.billing_information.billing_name);
				jQuery(".billing-address-one").val(
						billingInfoData.billing_information.billing_address1);

				if (billingInfoData.billing_information.billing_address2 != null) {
					jQuery(".billing-address-two")
							.val(
									billingInfoData.billing_information.billing_address2);
				}

				jQuery(".billing-city").val(
						billingInfoData.billing_information.billing_city);
				jQuery(".add-billing-select").val(
						billingInfoData.billing_information.billing_state);
				jQuery(".billing-zip").val(
						billingInfoData.billing_information.billing_zip5);
			}
		};
		var setCordovaFunctions = function(functionDefinitionArray){
		    this.triggerSavingDialog = functionDefinitionArray[0];
            this.sendMessage = functionDefinitionArray[1];
            this.bindMonthPicker = functionDefinitionArray[2];
            this.errorHandlerRegexValidation = functionDefinitionArray[3];
		}
	</script>

	<form name="input" id="update_billing" class="form-frame" method="post">

		<!-- <iframe id="mdliveframe" name="mdliveframe" src="http://localhost:8087/hpci/templateindex.html" frameborder="0" height:"80">If you can see this, your browser doesn't understand IFRAME.</iframe> -->

		<!--Production HPCI iFrame -->
		<iframe id="mdliveframe" name="mdliveframe"
			src="https://cc.hostedpci.com/iSynSApp/showPxyPage!ccFrame.action?pgmode1=prod&locationName=mobile&sid=527123&fullParentHost=file%3A%2F%2F%2Fandroid_asset%2Fhtdocs%2Fhpci%2Findex_prod.html"
			frameborder="0"  scrolling="no"> If you can see
			this, your browser doesn't understand IFRAME. </iframe>

		<input type="hidden" id="ccNum" name="mdliveCCNum" value="" /> <input
			type="hidden" id="ccCVV" name="mdliveCCCVV" value="" />
	<div style="margin-left: 7px;">
		<div class="add-billing-cc-expired-month-content">
			<div
				class="add-billing-cc-expired-month add-billing-title mdlive-default-font-family">Expiration
				month/year*</div>
            <div class = "add-billing-expDate-container"  onclick="bindMonthPicker(); return false;" >
                <input class="add-billing-input add-billing-expDate add-billing-required-fields"
                    placeholder="Expiration month/year" maxlength="19" disabled/>
            </div>
		</div>

		<div class="add-billing-name-content">
			<div
				class="add-billing-name add-billing-title mdlive-default-font-family">Name
				on card*</div>
			<input
				class="add-billing-input billing-name add-billing-required-fields"
				placeholder="Billing name" value="" />
		</div>
		<div class="add-billing-address-one-content">
			<div
				class="add-billing-address-one add-billing-title mdlive-default-font-family">Address
				1*</div>
			<input
				class="add-billing-input billing-address-one add-billing-required-fields"
				placeholder="Address 1" value="" />
		</div>
		<div class="add-billing-address-two-content">
			<div
				class="add-billing-address-two add-billing-title mdlive-default-font-family">Address
				2</div>
			<input class="add-billing-input billing-address-two"
				placeholder="Address 2" value="" />
		</div>
		<div class="add-billing-city-content">
			<div
				class="add-billing-city add-billing-title mdlive-default-font-family">City*</div>
			<input
				class="add-billing-input billing-city add-billing-required-fields"
				placeholder="City" value="">
		</div>
		<div class="add-billing-state-content">
			<div
				class="add-billing-state add-billing-title mdlive-default-font-family">State*</div>
			<select
				class="add-billing-select add-billing-required-fields billing-state mdlive-default-font-style color-gray">
				<option value="0" selected disabled="disabled">State</option>
				<option value="AL">Alabama</option>
				<option value="AK">Alaska</option>
				<option value="AM">American Samoa</option>
				<option value="AZ">Arizona</option>
				<option value="AR">Arkansas</option>
				<option value="AE">Armed Forces Europe</option>

				<option value="CA">California</option>
				<option value="CO">Colorado</option>
				<option value="CT">Connecticut</option>
				<option value="DE">Delaware</option>
				<option value="DC">District Of Columbia</option>

				<option value="FM">Federated States Of Micronesia</option>
				<option value="FL">Florida</option>
				<option value="GA">Georgia</option>
				<option value="GU">Guam</option>
				<option value="HI">Hawaii</option>
				<option value="ID">Idaho</option>
				<option value="IL">Illinois</option>

				<option value="IN">Indiana</option>
				<option value="IA">Iowa</option>
				<option value="KS">Kansas</option>
				<option value="KY">Kentucky</option>
				<option value="LA">Louisiana</option>

				<option value="ME">Maine</option>
				<option value="MD">Maryland</option>
				<option value="MH">Marshall Islands</option>
				<option value="MA">Massachusetts</option>
				<option value="MI">Michigan</option>
				<option value="MN">Minnesota</option>

				<option value="MS">Mississipi</option>
				<option value="MO">Missouri</option>
				<option value="MT">Montana</option>
				<option value="NE">Nebraska</option>
				<option value="NV">Nevada</option>

				<option value="NH">New Hampshire</option>
				<option value="NJ">New Jersey</option>
				<option value="NM">New Mexico</option>
				<option value="NY">New York</option>
				<option value="NC">North Carolina</option>

				<option value="ND">North Dakota</option>
				<option value="MP">Northern Mariana Islands</option>
				<option value="OH">Ohio</option>
				<option value="OK">Oklahoma</option>
				<option value="OR">Oregon</option>
				<option value="PW">Palau</option>
				<option value="PA">Pennsylvania</option>

				<option value="PR">Puerto Rico</option>
				<option value="RI">Rhode Island</option>
				<option value="SC">South Carolina</option>
				<option value="SD">South Dakota</option>
				<option value="TN">Tennessee</option>
				<option value="TX">Texas</option>

				<option value="UT">Utah</option>
				<option value="VT">Vermont</option>
				<option value="VI">Virgin Islands</option>
				<option value="VA">Virginia</option>
				<option value="WA">Washington</option>
				<option value="WV">West Virginia</option>
				<option value="WI">Wisconsin</option>
				<option value="WY">Wyoming</option>
			</select>
		</div>
		<div class="add-billing-zip-content">
			<div
				class="add-billing-zip add-billing-title mdlive-default-font-family">Zip*</div>
			<input
				class="add-billing-input billing-zip add-billing-required-fields"
				type="text" pattern="[0-9]*" placeholder="Zip" value=""
				maxlength="5" />
		</div>
		<div class="billing-save-button"
			onclick="tokenizeForm(); return false;">Save</div>
	</div>
	</form>
</body>

</html>